<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f8fdff">
    <title>Yakutia Market</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        :root {
            --primary: #00639b; --on-primary: #ffffff;
            --surface: #f8fdff; --surface-container: #f0f4f8;
            --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--surface); color: #191c1e; font-family: 'Roboto', sans-serif; padding-bottom: 80px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .top-app-bar { position: sticky; top: 0; z-index: 100; background: var(--surface-container); height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .brand { font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-filled { background: var(--primary); color: var(--on-primary); border: none; padding: 0 24px; height: 40px; border-radius: 20px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; padding: 16px; }
        .md-card { background: #fff; border-radius: var(--radius); border: 1px solid #eee; overflow: hidden; position: relative; }
        .card-media { height: 160px; background: #eee; position: relative; }
        .card-media img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 12px; }
        .headline { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px;}
        .subhead { font-size: 12px; color: #666; margin-bottom: 8px; }
        .price { font-size: 16px; font-weight: bold; color: var(--primary); }
        
        .role-card { background: var(--surface-container); padding: 24px; border-radius: 16px; margin: 8px 0; cursor: pointer; display: flex; align-items: center; gap: 16px; font-weight: 500; font-size: 18px; }
        .profile-header { display: flex; align-items: center; gap: 16px; margin-top: 24px; margin-bottom: 24px; }
        .avatar-xl { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 16px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 16px; }
        
        /* CHAT BOT STYLES */
        .fab-main { position: fixed; bottom: 90px; right: 16px; width: 56px; height: 56px; border-radius: 16px; background: #eaddff; color: #21005d; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: none; cursor: pointer; z-index: 90; transition: transform 0.2s; }
        .fab-main:hover { transform: scale(1.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .ai-dialog { background: white; width: 90%; max-width: 400px; height: 500px; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .ai-header { padding: 16px; background: var(--primary); color: white; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .ai-messages { flex: 1; overflow-y: auto; padding: 16px; background: #f5f5f5; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 80%; line-height: 1.4; font-size: 14px; }
        .msg.bot { background: white; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.user { background: #d0e4ff; align-self: flex-end; border-bottom-right-radius: 4px; color: #001d32; }
        .ai-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 8px; }
        .ai-input-area input { flex: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 16px; outline: none; }
        
        .cart-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; }
        .cart-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .qty { display: flex; align-items: center; gap: 8px; margin-left: auto; }

        .edit-fab, .delete-fab { position: absolute; top: 8px; width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .edit-fab { right: 44px; background: white; color: black; }
        .delete-fab { right: 8px; background: white; color: #ba1a1a; }
        
        .search-bar { background: var(--surface-container); border-radius: 24px; padding: 0 16px; height: 48px; display: flex; align-items: center; margin: 16px; }
        .search-bar input { border: none; background: transparent; flex: 1; height: 100%; font-size: 16px; margin-left: 8px; outline: none; }
        .categories { display: flex; gap: 8px; overflow-x: auto; padding: 0 16px 16px; }
        .chip { padding: 8px 16px; background: var(--surface-container); border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        /** YAKUTIA MARKET CORE + AI BRAIN */
        
        // --- 1. DB & STORE ---
        const DB = {
            get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } },
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            toBase64: file => new Promise((res, rej) => {
                const r = new FileReader(); r.readAsDataURL(file); 
                r.onload = () => res(r.result); r.onerror = rej;
            })
        };

        const defaultProducts = [
            { id: 1, title: 'Колбаса "Якутская"', price: 850, category: 'meat', seller: 'ТД «Якутия»', img: 'https://placehold.co/400x300/00639b/white?text=Sausage' },
            { id: 2, title: 'Оленина с/к', price: 1200, category: 'meat', seller: 'Мясокомбинат', img: 'https://placehold.co/400x300/00639b/white?text=Venison' },
            { id: 3, title: 'Жеребятина', price: 3500, category: 'meat', seller: 'ТД «Якутия»', img: 'https://placehold.co/400x300/00639b/white?text=Horse+Meat' },
            { id: 4, title: 'Кефир 3.2%', price: 120, category: 'milk', seller: 'Туймаада', img: 'https://placehold.co/400x300/00639b/white?text=Kefir' },
            { id: 5, title: 'Сливки 35%', price: 300, category: 'milk', seller: 'Чочур Муран', img: 'https://placehold.co/400x300/00639b/white?text=Cream' },
            { id: 6, title: 'Конфеты "Птичка"', price: 600, category: 'sweets', seller: 'Ф-ка Ситэ', img: 'https://placehold.co/400x300/00639b/white?text=Candy' },
            { id: 7, title: 'Унты Меховые', price: 25000, category: 'clothes', seller: 'Сардана', img: 'https://placehold.co/400x300/00639b/white?text=Fur+Boots' },
            { id: 8, title: 'Брелок Мамонт', price: 1500, category: 'souvenir', seller: 'Кудай Бахсы', img: 'https://placehold.co/400x300/00639b/white?text=Mammoth' },
            { id: 9, title: 'Чай "Таежный"', price: 350, category: 'eco', seller: 'Arctic Natural', img: 'https://placehold.co/400x300/00639b/white?text=Tea' }
        ];

        const store = {
            state: {
                user: DB.get('user', null),
                lang: DB.get('lang', 'ru'),
                products: DB.get('products', defaultProducts),
                cart: DB.get('cart', []),
                orders: DB.get('orders', []),
                page: 'home',
                aiOpen: false,
                aiHistory: [{text: 'Привет! Я AI-помощник. Спроси меня про рецепты или доставку.', from: 'bot'}]
            },
            update(fn) {
                fn(this.state);
                DB.set('user', this.state.user);
                DB.set('lang', this.state.lang);
                DB.set('products', this.state.products);
                DB.set('cart', this.state.cart);
                DB.set('orders', this.state.orders);
                render();
            }
        };

        // --- 2. AI LOGIC (SMART RESPONSES) ---
        const AI_BRAIN = {
            'рецепт': 'Для оленины: нарежьте стейки, обжарьте по 2 мин с каждой стороны. Подавайте с брусничным соусом.',
            'оленин': 'Оленина — диетическое мясо. У нас есть вырезка от ТД «Якутия» за 1200₽.',
            'рыба': 'Свежий Чир идеален для строганины. Также рекомендую копченого муксуна.',
            'доставк': 'Доставка по Якутску бесплатна при заказе от 2000₽. Работаем с 9:00 до 21:00.',
            'цен': 'Цены у нас от производителей. Никаких наценок посредников.',
            'привет': 'Здравствуйте! Чем могу помочь? Ищете мясо или рыбу?',
            'одежда': 'У нас есть унты от фирмы "Сардана". Очень теплые!',
            'default': 'Извините, я пока учусь. Попробуйте спросить про "рецепт", "оленину" или "доставку".'
        };

        // --- 3. CONTROLLER ---
        const Actions = {
            nav: (p) => store.update(s => s.page = p),
            lang: () => store.update(s => s.lang = s.lang==='ru'?'en':'ru'),
            login: (role) => store.update(s => { 
                s.user = { id: Date.now(), role, name: role==='seller'?'Айаал Фермер':'Покупатель' }; 
                s.page = 'profile'; 
            }),
            logout: () => store.update(s => { s.user = null; s.page = 'home'; }),
            
            add: (id) => store.update(s => {
                const p = s.products.find(x=>x.id===id), ex = s.cart.find(x=>x.id===id);
                if(ex) ex.quantity++; else s.cart.push({...p, quantity:1});
                alert('Добавлено!');
            }),
            checkout: () => store.update(s => {
                s.orders.push({id: Date.now(), items:[...s.cart], date: new Date().toLocaleString()});
                s.cart = []; alert('Заказ оформлен!');
            }),
            
            // AI Functions
            toggleAI: () => store.update(s => s.aiOpen = !s.aiOpen),
            sendAI: () => {
                const input = document.getElementById('ai-input');
                const text = input.value.trim();
                if(!text) return;
                
                store.update(s => s.aiHistory.push({text, from: 'user'}));
                
                // Smart Mock Logic
                const lower = text.toLowerCase();
                let reply = AI_BRAIN['default'];
                for(let k in AI_BRAIN) {
                    if(lower.includes(k)) { reply = AI_BRAIN[k]; break; }
                }
                
                setTimeout(() => {
                    store.update(s => s.aiHistory.push({text: reply, from: 'bot'}));
                    const el = document.getElementById('chat-scroll');
                    if(el) el.scrollTop = el.scrollHeight;
                }, 600);
            },

            filter: (c) => render(c),
            // CRUD
            addProductPrompt: () => document.getElementById('img-input').click(),
            handleFile: async (input) => {
                if(!input.files[0]) return;
                const img = await DB.toBase64(input.files[0]);
                const title = prompt("Название?");
                const price = prompt("Цена?");
                if(title && price) store.update(s => s.products.push({
                    id: Date.now(), title, price: Number(price), category:'meat', seller: 'Мой магазин', img
                }));
            },
            delete: (id) => { if(confirm('Удалить?')) store.update(s => s.products = s.products.filter(p=>p.id!==id)); },
            edit: (id) => { 
                const p = store.state.products.find(x=>x.id===id);
                const np = prompt("Новая цена?", p.price);
                if(np) store.update(s => p.price = Number(np));
            }
        };

        // --- 4. VIEWS ---
        const Icon = n => `<span class="material-symbols-rounded">${n}</span>`;

        function PageHome(s, catFilter) {
            const list = catFilter && catFilter !== 'all' ? s.products.filter(p => p.category === catFilter) : s.products;
            return `
                <div class="search-bar">${Icon('search')} <input placeholder="Поиск продуктов..."></div>
                <div class="categories">
                    <button class="chip" onclick="Actions.filter('all')">Все</button>
                    <button class="chip" onclick="Actions.filter('meat')">Мясо</button>
                    <button class="chip" onclick="Actions.filter('milk')">Молоко</button>
                    <button class="chip" onclick="Actions.filter('sweets')">Сладости</button>
                    <button class="chip" onclick="Actions.filter('clothes')">Одежда</button>
                    <button class="chip" onclick="Actions.filter('eco')">Эко</button>
                </div>
                <div class="card-grid">
                    ${list.map(p => `
                        <div class="md-card">
                            <div class="card-media">
                                <img src="${p.img}">
                                ${s.user?.role === 'seller' ? `
                                    <button class="edit-fab" onclick="Actions.edit(${p.id})">${Icon('edit')}</button>
                                    <button class="delete-fab" onclick="Actions.delete(${p.id})">${Icon('delete')}</button>
                                ` : ''}
                            </div>
                            <div class="card-content">
                                <div class="headline">${p.title}</div>
                                <div class="subhead">${p.seller}</div>
                                <div class="price">${p.price} ₽</div>
                                <button class="btn-filled" style="width:100%; margin-top:8px" onclick="Actions.add(${p.id})">В корзину</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function PageProfile(s) {
            if(!s.user) return `
                <div class="auth-container">
                    <h1>Вход</h1>
                    <div class="role-card" onclick="Actions.login('buyer')">${Icon('shopping_bag')} Покупатель</div>
                    <div class="role-card" onclick="Actions.login('seller')">${Icon('store')} Продавец</div>
                </div>`;
            return `
                <div class="container">
                    <div class="profile-header">
                        <div class="avatar-xl">${s.user.name[0]}</div>
                        <div><h2>${s.user.name}</h2><div>${s.user.role}</div></div>
                    </div>
                    ${s.user.role === 'seller' ? `
                        <div class="role-card" onclick="Actions.addProductPrompt()">
                            ${Icon('add_a_photo')} Добавить товар
                            <input type="file" id="img-input" hidden onchange="Actions.handleFile(this)">
                        </div>
                    ` : ''}
                    <div class="menu-item" style="color:red" onclick="Actions.logout()">${Icon('logout')} Выйти</div>
                </div>
            `;
        }

        function PageCart(s) {
            return `<div class="container"><h1>Корзина (${s.cart.length})</h1>
                ${s.cart.map(i => `<div class="cart-item"><img src="${i.img}"><div><b>${i.title}</b><br>${i.price} ₽</div></div>`).join('')}
                ${s.cart.length ? `<button class="btn-filled" style="width:100%; margin-top:20px" onclick="Actions.checkout()">Заказать</button>` : '<p>Пусто</p>'}
            </div>`;
        }

        // --- 5. RENDERER ---
        function render(catFilter = 'all') {
            const s = store.state;
            const app = document.getElementById('app');
            
            let content = '';
            if (s.page === 'home') content = PageHome(s, catFilter);
            else if (s.page === 'profile') content = PageProfile(s);
            else if (s.page === 'cart') content = PageCart(s);

            app.innerHTML = `
                <header class="top-app-bar">
                    <div class="brand" onclick="Actions.nav('home')">${Icon('storefront')} YakutiaMarket</div>
                    <div style="display:flex; gap:10px">
                        <button class="btn-icon" onclick="Actions.nav('profile')">${Icon('person')}</button>
                        <button class="btn-icon" onclick="Actions.nav('cart')">${Icon('shopping_bag')} ${s.cart.length||''}</button>
                    </div>
                </header>
                <main>${content}</main>
                <button class="fab-main" onclick="Actions.toggleAI()">${Icon('smart_toy')}</button>
                ${s.aiOpen ? `
                    <div class="modal-overlay" onclick="Actions.toggleAI()">
                        <div class="ai-dialog" onclick="event.stopPropagation()">
                            <div class="ai-header">${Icon('smart_toy')} AI Помощник <div style="margin-left:auto; cursor:pointer" onclick="Actions.toggleAI()">${Icon('close')}</div></div>
                            <div class="ai-messages" id="chat-scroll">
                                ${s.aiHistory.map(m => `<div class="msg ${m.from}">${m.text}</div>`).join('')}
                            </div>
                            <div class="ai-input-area">
                                <input id="ai-input" placeholder="Напиши 'рецепт' или 'доставка'..." onkeypress="if(event.key==='Enter') Actions.sendAI()">
                                <button class="btn-icon" onclick="Actions.sendAI()">${Icon('send')}</button>
                            </div>
                        </div>
                    </div>` : ''}
            `;
        }

        // INIT
        if(!localStorage.getItem('v5_loaded')) { localStorage.clear(); localStorage.setItem('v5_loaded', 'true'); }
        render();
    </script>
</body>
</html>
